name: Backend CI/CD

on:
  push:
    branches:
      - master
      - test

jobs:
  build:
    runs-on: ubuntu-latest
    # runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Alibaba Cloud Container Registry
        uses: docker/login-action@v2
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ALI_DOCKER_USERNAME }}
          password: ${{ secrets.ALI_DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: ./PanelSurveyBackend
          file: ./PanelSurveyBackend/Dockerfile
          push: true
          # 禁用构建证明（Provenance），有时能解决上传卡死问题，且能减小镜像体积
          provenance: false
          tags: |
            registry.cn-hangzhou.aliyuncs.com/matrix-studio/panel-survey-backend:${{ github.ref == 'refs/heads/master' && 'master' || 'dev' }}

      - name: Set up SSH Key
        run: |
          mkdir -p ~/.ssh
          if [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "${{ secrets.PROD_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          else
            echo "${{ secrets.DEV_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          fi
          sed -i -e '$a\' ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          chmod 700 ~/.ssh

      - name: Add Known Hosts
        run: |
          if [ "${{ github.ref }}" == "refs/heads/master" ]; then
            ssh-keyscan -H "${{ secrets.PROD_REMOTE_HOST }}" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -H "${{ secrets.DEV_REMOTE_HOST }}" >> ~/.ssh/known_hosts
          fi
          chmod 600 ~/.ssh/known_hosts

      - name: Prepare Deployment Scripts
        run: |
          cd Backend/
          mkdir -p deploy_scripts
          if [ "${{ github.ref }}" == "refs/heads/master" ]; then
            cp docker-compose-prod.yml deploy_scripts/
          else
            cp docker-compose-dev.yml deploy_scripts/
          fi
          cp Makefile deploy_scripts/

      - name: Deploy to Server
        uses: easingthemes/ssh-deploy@v2.1.5
        env:
          SSH_PRIVATE_KEY: ${{ github.ref == 'refs/heads/master' && secrets.PROD_SSH_PRIVATE_KEY || secrets.DEV_SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ github.ref == 'refs/heads/master' && secrets.PROD_REMOTE_HOST || secrets.DEV_REMOTE_HOST }}
          REMOTE_USER: root
          SOURCE: PanelSurveyBackend/deploy_scripts/*
          TARGET: ${{ github.ref == 'refs/heads/master' && secrets.PROD_DEPLOY_TARGET || secrets.DEV_DEPLOY_TARGET }}/PanelSurveyBackend

      - name: Run Remote SSH Commands
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ github.ref == 'refs/heads/master' && secrets.PROD_REMOTE_HOST || secrets.TEST_REMOTE_HOST }}
          username: root
          key: ${{ github.ref == 'refs/heads/master' && secrets.PROD_SSH_PRIVATE_KEY || secrets.TEST_SSH_PRIVATE_KEY }}
          debug: true
          script: |
            cd ${{ github.ref == 'refs/heads/master' && secrets.PROD_DEPLOY_TARGET || secrets.TEST_DEPLOY_TARGET }}/Backend
            sudo docker login --username=${{ secrets.ALI_DOCKER_USERNAME }} --password=${{ secrets.ALI_DOCKER_PASSWORD }} registry.cn-hangzhou.aliyuncs.com
            if [ "${{ github.ref }}" == "refs/heads/master" ]; then
              make pull_prod
              make restart_prod
            else
              make pull_test
              make restart_test
            fi
            sudo docker image prune -a -f
            sudo docker logout registry.cn-hangzhou.aliyuncs.com
            
      - name: 钉钉通知
        if: always()
        uses: zcong1993/actions-ding@master
        with:
          dingToken: ${{ secrets.DINGTALK_ACCESS_TOKEN }}
          body: |
            {
              "msgtype": "markdown",
              "markdown": {
                "title": "CI/CD 通知",
                "text": "### CI/CD 运行报告\n\n**项目**: ${{ github.repository }}\n\n**分支**: `${{ github.ref_name }}`\n\n**状态**: ${{ job.status == 'success' && '✅ 成功' || (job.status == 'failure' && '❌ 失败' || '⚠️ 取消') }}\n\n**执行人**: ${{ github.actor }}\n\n[点击查看详情](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
              }
            }