name: Code Quality Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  analyze-code-quality:
    runs-on: ubuntu-latest
    # runs-on: self-hosted
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Install fuck-u-code
        run: go install github.com/Done-0/fuck-u-code/cmd/fuck-u-code@latest
        
      - name: Run code quality analysis
        id: analysis
        run: |
          echo "ğŸ” å¼€å§‹åˆ†æä»£ç è´¨é‡..."
          
          # è¿è¡Œåˆ†æï¼Œæ’é™¤å¸¸è§ä¸éœ€è¦åˆ†æçš„ç›®å½•
          fuck-u-code analyze \
            --markdown \
            --summary \
            --top 10 \
            --exclude "**/node_modules/**" \
            --exclude "**/vendor/**" \
            --exclude "**/dist/**" \
            --exclude "**/build/**" \
            --exclude "**/.next/**" \
            --exclude "**/coverage/**" \
            --exclude "**/*.min.js" \
            --exclude "**/*.bundle.js" > code-quality-report.md || true
          
          # å¦‚æœæŠ¥å‘Šæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤æŠ¥å‘Š
          if [ ! -f code-quality-report.md ]; then
            echo "# ä»£ç è´¨é‡åˆ†ææŠ¥å‘Š\n\nåˆ†æå·¥å…·æœªèƒ½ç”ŸæˆæŠ¥å‘Šã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºé¡¹ç›®ä¸­æ²¡æœ‰æ‰¾åˆ°å¯åˆ†æçš„æºä»£ç æ–‡ä»¶ã€‚" > code-quality-report.md
          fi
          
          # é™åˆ¶æŠ¥å‘Šå¤§å° (GitHub è¯„è®ºæœ€å¤§ 65536 å­—ç¬¦)
          if [ $(stat -c%s code-quality-report.md 2>/dev/null || stat -f%z code-quality-report.md 2>/dev/null) -gt 60000 ]; then
            echo "âš ï¸ æŠ¥å‘Šæ–‡ä»¶è¿‡å¤§ï¼Œè¿›è¡Œæˆªæ–­ä»¥ç¬¦åˆ GitHub è¯„è®ºå¤§å°é™åˆ¶"
            head -c 60000 code-quality-report.md > temp.md && mv temp.md code-quality-report.md
            echo -e "\n\n[...] æŠ¥å‘Šå·²è¢«æˆªæ–­ï¼Œå®Œæ•´æŠ¥å‘Šè¯·åœ¨æœ¬åœ°è¿è¡Œ fuck-u-code æŸ¥çœ‹" >> code-quality-report.md
          fi
          
          echo "âœ… ä»£ç è´¨é‡åˆ†æå®Œæˆ"
      
      - name: Comment PR with analysis results
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // è¯»å–æŠ¥å‘Šæ–‡ä»¶
            const reportPath = path.join(process.cwd(), 'code-quality-report.md');
            let reportContent = '';
            
            try {
              reportContent = fs.readFileSync(reportPath, 'utf8');
              console.log('æŠ¥å‘Šæ–‡ä»¶è¯»å–æˆåŠŸ');
            } catch (error) {
              console.error('è¯»å–æŠ¥å‘Šæ–‡ä»¶å¤±è´¥:', error);
              reportContent = '# ä»£ç è´¨é‡åˆ†ææŠ¥å‘Š\n\næ— æ³•è¯»å–åˆ†ææŠ¥å‘Šã€‚è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚';
            }
            
            // åˆ›å»ºè¯„è®ºå†…å®¹
            const commentContent = `
            ## ğŸš¨ ä»£ç è´¨é‡åˆ†ææŠ¥å‘Š
            
            ${reportContent}
            
            > â„¹ï¸ æ³¨: æœ¬æŠ¥å‘Šç”± [fuck-u-code](https://github.com/Done-0/fuck-u-code) è‡ªåŠ¨ç”Ÿæˆã€‚åˆ†æ•°è¶Šé«˜è¡¨ç¤ºä»£ç è´¨é‡è¶Šå·®ï¼ˆ0-100åˆ†ï¼‰ã€‚
            `;
            
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            
            try {
              // è·å–å·²å­˜åœ¨çš„è¯„è®º
              const { data: comments } = await github.rest.issues.listComments({
                owner,
                repo,
                issue_number
              });
              
              // æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ç”±è¯¥å·¥ä½œæµåˆ›å»ºçš„è¯„è®º
              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('ä»£ç è´¨é‡åˆ†ææŠ¥å‘Š')
              );
              
              if (botComment) {
                // æ›´æ–°ç°æœ‰è¯„è®º
                await github.rest.issues.updateComment({
                  owner,
                  repo,
                  comment_id: botComment.id,
                  body: commentContent
                });
                console.log('ğŸ“ å·²æ›´æ–°ç°æœ‰è¯„è®º');
              } else {
                // åˆ›å»ºæ–°è¯„è®º
                await github.rest.issues.createComment({
                  issue_number,
                  owner,
                  repo,
                  body: commentContent
                });
                console.log('ğŸ“ å·²åˆ›å»ºæ–°è¯„è®º');
              }
            } catch (error) {
              console.error('âŒ è¯„è®º PR æ—¶å‡ºé”™:', error);
              // å¦‚æœè¯„è®ºå¤±è´¥ï¼Œå°†é”™è¯¯å†™å…¥æ–‡ä»¶ä»¥ä¾¿è°ƒè¯•
              fs.writeFileSync('comment-error.log', JSON.stringify(error, null, 2));
            }
